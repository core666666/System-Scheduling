@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager NavigationManager
@inject SchedulingApplication.Services.AuthService AuthService
@inject ILogger<MainLayout> Logger
@inject AuthenticationStateProvider AuthStateProvider

<AuthorizeView>
    <Authorized Context="authContext">
        @{
            Logger.LogInformation($"MainLayout Authorized Context - User: {authContext.User?.Identity?.Name}, IsAuthenticated: {authContext.User?.Identity?.IsAuthenticated}");
        }
        <div class="page">
            <div class="sidebar">
                <NavMenu />
            </div>

            <main>
                <div class="top-row px-4">
                    <div class="ms-auto d-flex align-items-center">
                        <div class="user-info me-3">
                            <i class="fas fa-user-circle me-1"></i>
                            <span>@authContext.User?.Identity?.Name</span>
                        </div>
                        <button class="btn btn-link" @onclick="HandleLogout">退出登录</button>
                    </div>
                </div>

                <article class="content px-4">
                    @Body
                </article>
            </main>
        </div>
    </Authorized>
    <NotAuthorized>
        @{
            Logger.LogWarning("MainLayout NotAuthorized Context - User not authenticated");
        }
        <div class="page">
            <main>
                <article class="content px-4">
                    @Body
                </article>
            </main>
        </div>
    </NotAuthorized>
</AuthorizeView>

<style>
    .user-info {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        color: #555;
        padding: 0.25rem 0.75rem;
        background-color: #f8f9fa;
        border-radius: 20px;
        border: 1px solid #dee2e6;
    }
    
    .user-info i {
        color: #3a0647;
        font-size: 1.1rem;
    }
</style>

@code {
    protected override void OnInitialized()
    {
        Logger.LogInformation($"MainLayout OnInitialized - Route: {NavigationManager.Uri}");
        NavigationManager.LocationChanged += HandleLocationChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("MainLayout OnInitializedAsync - Starting");
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        Logger.LogInformation($"MainLayout OnInitializedAsync - Auth State: User={authState.User?.Identity?.Name}, IsAuthenticated={authState.User?.Identity?.IsAuthenticated}");
    }

    protected override void OnParametersSet()
    {
        Logger.LogInformation("MainLayout OnParametersSet");
        base.OnParametersSet();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Logger.LogInformation("MainLayout OnAfterRenderAsync - First Render");
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            Logger.LogInformation($"MainLayout OnAfterRenderAsync - Auth State: User={authState.User?.Identity?.Name}, IsAuthenticated={authState.User?.Identity?.IsAuthenticated}");
        }
    }

    private void HandleLocationChanged(object sender, LocationChangedEventArgs e)
    {
        Logger.LogInformation($"MainLayout HandleLocationChanged - Navigation to: {e.Location}");
        InvokeAsync(async () =>
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            Logger.LogInformation($"MainLayout HandleLocationChanged - Auth State: User={authState.User?.Identity?.Name}, IsAuthenticated={authState.User?.Identity?.IsAuthenticated}");
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        Logger.LogInformation("MainLayout Dispose");
        NavigationManager.LocationChanged -= HandleLocationChanged;
    }

    private async Task HandleLogout()
    {
        Logger.LogInformation("MainLayout HandleLogout - Starting logout process");
        await AuthService.LogoutAsync();
        NavigationManager.NavigateTo("/login");
    }
} 